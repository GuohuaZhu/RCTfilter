<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>临床试验筛选工具</title>
    <!-- 加载 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 基础样式 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- 标题 -->
        <header class="mb-8 p-6 bg-white rounded-2xl shadow-md">
            <h1 class="text-3xl font-bold text-center text-gray-800">临床试验快速筛选工具</h1>
            <p class="text-center text-gray-500 mt-2">根据患者情况快速匹配符合的临床试验项目 (基于 RCT入排.docx)</p>
        </header>

        <!-- 筛选器 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-6 bg-white rounded-2xl shadow-md mb-8">
            <!-- 癌种 -->
            <div>
                <label for="cancer-select" class="block text-sm font-medium text-gray-700 mb-1">1. 癌种</label>
                <select id="cancer-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">所有癌种</option>
                    <option value="ovarian">卵巢癌/输卵管癌/腹膜癌</option>
                    <option value="endometrial">子宫内膜癌</option>
                    <option value="solid-tumor">其他实体瘤</option>
                </select>
            </div>
            <!-- 治疗线数 -->
            <div>
                <label for="lines-select" class="block text-sm font-medium text-gray-700 mb-1">2. 治疗线数</label>
                <select id="lines-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">所有线数</option>
                    <option value="1">1 线</option>
                    <option value="2">2 线</option>
                    <option value="3">3 线</option>
                    <option value="99">≥4 线</option>
                    <option value="0">N/A (不适用)</option>
                </select>
            </div>
            <!-- 铂类状态 -->
            <div>
                <label for="status-select" class="block text-sm font-medium text-gray-700 mb-1">3. 铂类状态</label>
                <select id="status-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">所有状态</option>
                    <option value="sensitive">铂敏感 (≥6m)</option>
                    <option value="sensitive-remission">铂敏感 (末次缓解/维持)</option>
                    <option value="resistant">铂耐药 (≤6m)</option>
                    <option value="na">N/A (不适用)</option>
                </select>
            </div>
            <!-- 分子靶点 -->
            <div>
                <label for="target-select" class="block text-sm font-medium text-gray-700 mb-1">4. 分子靶点 (可选)</label>
                <select id="target-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">所有靶点</option>
                    <option value="B7-H4">B7-H4</option>
                    <option value="PARP">PARP</option>
                    <option value="FRα">FRα</option>
                    <option value="HER2">HER2</option>
                </select>
            </div>
        </div>

        <!-- 筛选按钮 -->
        <div class="text-center mb-8">
            <button id="filter-button" class="w-full md:w-auto px-10 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-200 transform hover:scale-105">
                立即筛选
            </button>
        </div>

        <!-- 结果区域 -->
        <div id="results-container" class="space-y-6">
            <!-- 初始提示信息 -->
            <div id="initial-message" class="text-center text-gray-500 p-10 bg-white rounded-2xl shadow-md">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10.5a.5.5 0 01.5-.5h3a.5.5 0 010 1h-3a.5.5 0 01-.5-.5zM10 13.5a.5.5 0 01.5-.5h3a.5.5 0 010 1h-3a.5.5 0 01-.5-.5z" />
                </svg>
                <h3 class="mt-2 text-lg font-semibold">请选择筛选条件</h3>
                <p class="mt-1 text-sm">请在上方选择癌种、线数、状态或靶点，然后点击“立即筛选”按钮。</p>
            </div>
            <!-- 筛选结果将动态插入此处 -->
        </div>
    </div>

    <!-- 
      核心脚本
      1. 加载外部的试验数据
      2. 运行筛选逻辑
    -->
    <script src="data.js"></script>

    <script>
        // --- DOM 元素 ---
        const cancerSelect = document.getElementById('cancer-select');
        const linesSelect = document.getElementById('lines-select');
        const statusSelect = document.getElementById('status-select');
        const targetSelect = document.getElementById('target-select');
        const filterButton = document.getElementById('filter-button');
        const resultsContainer = document.getElementById('results-container');
        const initialMessage = document.getElementById('initial-message');

        // 绑定点击事件
        if (filterButton) {
            filterButton.addEventListener('click', filterTrials);
        } else {
            console.error("错误：未找到 'filter-button' 按钮。");
        }


        /**
         * 主筛选函数
         */
        function filterTrials() {
            // 确保 trialsData 已加载
            if (typeof trialsData === 'undefined' || trialsData === null) {
                console.error('试验数据 (data.js) 未加载或为空。');
                resultsContainer.innerHTML = `
                    <div class="text-center text-red-500 p-10 bg-white rounded-2xl shadow-md">
                        <h3 class="mt-2 text-lg font-semibold">加载错误</h3>
                        <p class="mt-1 text-sm">无法加载试验数据 (data.js)，请检查文件是否存在且内容正确。</p>
                    </div>
                `;
                if (initialMessage) {
                    initialMessage.style.display = 'none';
                }
                return;
            }

            // 隐藏初始消息
            if (initialMessage) {
                initialMessage.style.display = 'none';
            }

            // 获取筛选值
            const selectedCancer = cancerSelect.value;
            const selectedLine = linesSelect.value;
            const selectedStatus = statusSelect.value;
            const selectedTarget = targetSelect.value;

            // 执行筛选
            const matchedTrials = trialsData.filter(trial => {
                // 1. 癌种筛选
                const cancerMatch = (selectedCancer === 'all') || (trial.cancer === selectedCancer);
                
                // 2. 线数筛选
                const lineMatch = (selectedLine === 'all') || trial.lines.includes(Number(selectedLine));

                // 3. 状态筛选
                const statusMatch = (selectedStatus === 'all') || trial.status.includes(selectedStatus);

                // 4. 靶点筛选
                const targetMatch = (selectedTarget === 'all') || (trial.target === selectedTarget);

                return cancerMatch && lineMatch && statusMatch && targetMatch;
            });

            // 渲染结果
            renderResults(matchedTrials, selectedTarget);
        }

        /**
         * 渲染筛选结果
         * @param {Array} trials - 筛选后的试验数组
         * @param {string} selectedTarget - 用户选择的靶点
         */
        function renderResults(trials, selectedTarget) {
            // 清空旧结果
            resultsContainer.innerHTML = '';

            if (trials.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 p-10 bg-white rounded-2xl shadow-md">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                        </svg>
                        <h3 class="mt-2 text-lg font-semibold">未找到匹配项</h3>
                        <p class="mt-1 text-sm">没有找到符合当前筛选条件的临床试验。请尝试放宽筛选条件。</p>
                    </div>
                `;
                return;
            }

            // 如果用户指定了靶点，就按该靶点分组
            // 如果用户没选靶点，就按试验本身的靶点动态分组
            const groups = trials.reduce((acc, trial) => {
                const key = (selectedTarget !== 'all') ? selectedTarget : (trial.target || '其他');
                if (!acc[key]) {
                    acc[key] = [];
                }
                acc[key].push(trial);
                return acc;
            }, {});

            // 排序：B7-H4, PARP, FRα, HER2, 其他
            const sortedGroupKeys = Object.keys(groups).sort((a, b) => {
                const order = { 'B7-H4': 1, 'PARP': 2, 'FRα': 3, 'HER2': 4, '其他': 99 };
                return (order[a] || 100) - (order[b] || 100);
            });

            // 循环渲染每个分组
            for (const targetName of sortedGroupKeys) {
                const trialsInGroup = groups[targetName];
                
                // 创建分组容器
                const groupEl = document.createElement('div');
                groupEl.className = 'bg-white rounded-2xl shadow-md overflow-hidden';
                
                // 分组标题
                let bgColor = 'bg-gray-600';
                if (targetName === 'B7-H4') bgColor = 'bg-blue-600';
                if (targetName === 'PARP') bgColor = 'bg-green-600';
                if (targetName === 'FRα') bgColor = 'bg-purple-600';
                if (targetName === 'HER2') bgColor = 'bg-red-600';

                let groupHTML = `
                    <div class="p-4 ${bgColor} text-white">
                        <h2 class="text-xl font-bold">靶点: ${targetName} (共 ${trialsInGroup.length} 项)</h2>
                    </div>
                    <ul class="divide-y divide-gray-200">
                `;

                // 渲染组内的每个试验
                for (const trial of trialsInGroup) {
                    groupHTML += `
                        <li class="p-4 hover:bg-gray-50">
                            <h3 class="text-lg font-semibold text-gray-900">${trial.name} (ID: ${trial.id})</h3>
                            <ul class="mt-2 list-disc list-inside space-y-1 text-gray-700">
                                ${trial.keyPoints.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </li>
                    `;
                }

                groupHTML += '</ul></div>';
                groupEl.innerHTML = groupHTML;
                resultsContainer.appendChild(groupEl);
            }
        }

    </script>
</body>
</html>
